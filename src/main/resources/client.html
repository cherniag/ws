<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Client</title>
    <style type="text/css">
        #usersOnline tr td{
            width: 50px;
            background-color: azure;
            border: 1px solid grey;
            padding: 20px;
        }

        #sessions tr td{
            width: 50px;
            background-color: green;
            border: 1px solid grey;
            padding: 20px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript">
        var wsocket;
        var userName;
        function connect() {
            wsocket = new WebSocket("ws://localhost:8026/websockets/lobby");
            wsocket.onmessage = onMessage;
            wsocket.onclose = function(){ alert('Connection closed!');};
            wsocket.onopen = function() { login(); };

        }

        function initUsers(response) {
            $('#usersOnline').html('');
             for(var i in response.payload) {
                 var user = response.payload[i];
                 $('#usersOnline').append($(createRow(user)));
             }
        }

        function onUserLoggedId(response) {
             for(var i in response.payload) {
                 var user = response.payload[i];
                 $('#usersOnline').append($(createRow(user)));
             }
        }

        function onUserLoggedOut(response) {
            for(var i in response.payload) {
                var user = response.payload[i];
                $('table#usersOnline tr#' + user.sessionId).remove();
            }
        }

        function createRow(user) {
            return '<tr id="' + user.sessionId + '"><td onclick="createSession(\''+ user.sessionId + '\')">' + user.userName + '</td></tr>';
        }

        function createSession(sessionId){
            wsocket.send(JSON.stringify(createRequest("GAME_SESSION_INIT", sessionId)));
        }

        function closeSession(sessionId){
            wsocket.send(JSON.stringify(createRequest("GAME_SESSION_CLOSE", sessionId)));
        }



        function onMessage(evt) {
            var response = JSON.parse(evt.data);
            $("#log").append($('<div>' + new Date() + ': ' + evt.data + '</div>'));
           // alert(evt.data);
            if(response.messageType == "USER_LIST"){
                initUsers(response);
            } else if(response.messageType == "USER_LOGGED_IN"){
                onUserLoggedId(response);
            } else if(response.messageType == "USER_LOGGED_OUT"){
                onUserLoggedOut(response);
            } else if(response.messageType == "USER_ERROR"){
                alert(response.payload);
            } else if(response.messageType == "GAME_SESSION_INIT"){
                var result = confirm("User " + response.payload.owner.userName + " invites you to private session. Confirm?");
                if(result) {
                    wsocket.send(JSON.stringify(createRequest("GAME_SESSION_ACCEPTED", response.payload.id)));
                } else {
                    wsocket.send(JSON.stringify(createRequest("GAME_SESSION_REJECTED", response.payload.id)));
                }
            } else if(response.messageType == "GAME_SESSION_CREATED"){
                var row = '<tr id="' + response.payload.id + '" onclick="closeSession(\'' + response.payload.id + '\')"><td>Owner[' + response.payload.owner.userName + '], Guest[' + response.payload.guest.userName + ']</td></tr>';
                $('#sessions').append($(row));
            } else if(response.messageType == "GAME_SESSION_REMOVED"){
                $('table#sessions tr#' + response.payload.id).remove();
            }

        }

        function login() {
            var userName = prompt("Please enter user name");
            if(userName != null) {
                 wsocket.send(JSON.stringify(createRequest("USER_TRY_LOGIN", userName)));
            } else {
                alert("User name is required! Refresh page and try again");
            }
        }

        function createRequest(type, payload) {
            var clientRequest = {};
            clientRequest.messageType = type;
            clientRequest.payload = payload;
            return clientRequest;
        }

/*        function sendMessage(msg) {
            waitForSocketConnection(wsocket, function() {
                wsocket.send(msg);
            });
        };


        function waitForSocketConnection(socket, callback){
                setTimeout(
                    function(){
                        if (socket.readyState === 1) {
                            if(callback !== undefined){
                                callback();
                            }
                            return;
                        } else {
                            waitForSocketConnection(socket,callback);
                        }
                    }, 100);
            };*/


        window.addEventListener("load", connect, false);
    </script>
</head>
<body>
<div style="width: 50%; float: left;">
    Users online:
    <table id="usersOnline">

    </table>
</div>

<div style="width: 50%; float: left;">
    Sessions:
    <table id="sessions">

    </table>
</div>
<div style="float: none; clear: both;"></div>
<br>
<br>
LOG:
<div id = "log"></div>
</body>
</html>