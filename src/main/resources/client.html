<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Client</title>
    <style type="text/css">
        #usersOnline tr td{
            width: 50px;
            background-color: azure;
            border: 1px solid grey;
            padding: 20px;
        }

        #sessions tr td{
            width: 50px;
            background-color: green;
            border: 1px solid grey;
            padding: 20px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript">
        var wsocket;
        var userName;
        function connect() {
            wsocket = new WebSocket("ws://localhost:8026/websockets/lobby");
            wsocket.onmessage = onMessage;
            login();
        }

        function send(){
            wsocket.send(document.getElementById("message").value);
        }

        function initUsers(response) {
            $('#usersOnline').html('');
             for(var i in response.payload) {
                 var user = response.payload[i];
                 $('#usersOnline').append($(createRow(user)));
             }
        }

        function userLoggedIn(response) {
             for(var i in response.payload) {
                 var user = response.payload[i];
                 $('#usersOnline').append($(createRow(user)));
             }
        }

        function userLoggedOut(response) {
            for(var i in response.payload) {
                var user = response.payload[i];
                $('table#usersOnline tr#' + user.sessionId).remove();
            }
        }

        function createRow(user) {
            return '<tr id="' + user.sessionId + '"><td onclick="createSession(\''+ user.sessionId + '\')">' + user.userName + '</td></tr>';
        }

        function createSession(sessionId){
            wsocket.send(JSON.stringify(createRequest("SESSION_REQUEST", sessionId)));
        }

        function closeSession(sessionId){
            wsocket.send(JSON.stringify(createRequest("SESSION_CLOSE_REQUEST", sessionId)));
        }



        function onMessage(evt) {
            var response = JSON.parse(evt.data);
            $("#log").append($('<div>' + new Date() + ': ' + evt.data + '</div>'));
           // alert(evt.data);
            if(response.responseType == "USER_LIST"){
                initUsers(response);
            } else if(response.responseType == "USER_LOGGED_IN"){
                userLoggedIn(response);
            } else if(response.responseType == "USER_LOGGED_OUT"){
                userLoggedOut(response);
            } else if(response.responseType == "ERROR"){
                alert(response.payload);
            } else if(response.responseType == "SESSION_REQUEST"){
                var result = confirm("User " + response.payload + " invites you to private session. Confirm?");
                if(result) {
                    wsocket.send(JSON.stringify(createRequest("SESSION_REQUEST_CONFIRM", response.payload)));
                } else {
                    wsocket.send(JSON.stringify(createRequest("SESSION_REQUEST_REJECT", response.payload)));
                }
            } else if(response.responseType == "SESSION_CREATED"){
                var row = '<tr id="' + response.payload.id + '" onclick="closeSession(\'' + response.payload.id + '\')"><td>Owner[' + response.payload.holder.userName + '], Guest[' + response.payload.guest.userName + ']</td></tr>';
                $('#sessions').append($(row));
            } else if(response.responseType == "SESSION_CLOSED"){
                $('table#sessions tr#' + response.payload.id).remove();
            }

        }

        function login() {
            var userName = prompt("Please enter user name");
            if(userName != null) {
                wsocket.send(JSON.stringify(createRequest("LOGIN", userName)));
            } else {
                alert("Please enter user name!");
            }
        }

        function createRequest(type, payload) {
            var clientRequest = {};
            clientRequest.type = type;
            clientRequest.payload = payload;
            return clientRequest;
        }


        window.addEventListener("load", connect, false);
    </script>
</head>
<body>
<div style="width: 50%; float: left;">
    Users online:
    <table id="usersOnline">

    </table>
</div>

<div style="width: 50%; float: left;">
    Sessions:
    <table id="sessions">

    </table>
</div>
<div style="float: none; clear: both;"></div>
<br>
<br>
LOG:
<div id = "log"></div>
</body>
</html>